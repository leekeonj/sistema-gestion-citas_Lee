name: CI - Pruebas Automatizadas y Cobertura

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
    
    - name: â˜• Configurar Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'
    
    - name: ðŸ” Verificar versiÃ³n de Java
      run: java -version
    
    - name: ðŸ“¦ Instalar dependencias y ejecutar pruebas
      run: mvn -B clean test
    
    - name: ðŸ“Š Generar reporte de cobertura con JaCoCo
      run: mvn -B jacoco:report
    
    - name: âœ… Verificar cobertura mÃ­nima (70%)
      run: mvn -B jacoco:check
      continue-on-error: true
    
    - name: ðŸ“ˆ Publicar reporte de cobertura
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-report
        path: target/site/jacoco/
    
    - name: ðŸ“‹ Resumen de resultados
      if: always()
      run: |
        echo "### ðŸ“Š Resultados de las Pruebas" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Pipeline ejecutado correctamente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Para ver el reporte de cobertura detallado:" >> $GITHUB_STEP_SUMMARY
        echo "1. Ve a la pestaÃ±a 'Actions'" >> $GITHUB_STEP_SUMMARY
        echo "2. Selecciona esta ejecuciÃ³n" >> $GITHUB_STEP_SUMMARY
        echo "3. Descarga el artifact 'jacoco-report'" >> $GITHUB_STEP_SUMMARY
        echo "4. Abre el archivo index.html" >> $GITHUB_STEP_SUMMARY
